name: Release Please

on:
  push:
    branches:
      - main
    tags:
      - 'agent-rdp-v*'
  workflow_dispatch:
    inputs:
      tag_name:
        description: 'Tag name for release (e.g., agent-rdp-v0.5.0)'
        required: true
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  release-please:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' && !startsWith(github.ref, 'refs/tags/')
    outputs:
      release_created: ${{ steps.release.outputs.release_created }}
      tag_name: ${{ steps.release.outputs.tag_name }}
    steps:
      - uses: googleapis/release-please-action@v4
        id: release
        with:
          config-file: release-please-config.json
          manifest-file: .release-please-manifest.json

  build:
    needs: release-please
    if: ${{ always() && (needs.release-please.outputs.release_created || github.event_name == 'workflow_dispatch' || startsWith(github.ref, 'refs/tags/')) }}
    strategy:
      matrix:
        include:
          - os: macos-latest
            target: aarch64-apple-darwin
            package: darwin-arm64
          - os: macos-latest
            target: x86_64-apple-darwin
            package: darwin-x64
          - os: ubuntu-latest
            target: x86_64-unknown-linux-gnu
            package: linux-x64
          - os: ubuntu-24.04-arm
            target: aarch64-unknown-linux-gnu
            package: linux-arm64
          - os: windows-latest
            target: x86_64-pc-windows-msvc
            package: win32-x64
            rustflags: "-C target-feature=+crt-static"
          - os: windows-11-arm
            target: aarch64-pc-windows-msvc
            package: win32-arm64
            rustflags: "-C target-feature=+crt-static"

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@v4

      - name: Install Rust
        uses: dtolnay/rust-toolchain@stable
        with:
          targets: ${{ matrix.target }}

      - name: Build
        env:
          RUSTFLAGS: ${{ matrix.rustflags }}
        run: cargo build --release --target ${{ matrix.target }}

      - name: Copy binary and models to package (Unix)
        if: runner.os != 'Windows'
        run: |
          mkdir -p packages/${{ matrix.package }}/bin
          mkdir -p packages/${{ matrix.package }}/models
          cp target/${{ matrix.target }}/release/agent-rdp packages/${{ matrix.package }}/bin/
          chmod +x packages/${{ matrix.package }}/bin/agent-rdp
          cp models/*.rten packages/${{ matrix.package }}/models/

      - name: Copy binary and models to package (Windows)
        if: runner.os == 'Windows'
        run: |
          New-Item -ItemType Directory -Force -Path packages/${{ matrix.package }}/bin
          New-Item -ItemType Directory -Force -Path packages/${{ matrix.package }}/models
          Copy-Item target/${{ matrix.target }}/release/agent-rdp.exe packages/${{ matrix.package }}/bin/
          Copy-Item models/*.rten packages/${{ matrix.package }}/models/

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: ${{ matrix.package }}
          path: packages/${{ matrix.package }}/

  publish:
    needs: [release-please, build]
    if: ${{ always() && needs.build.result == 'success' }}
    runs-on: ubuntu-latest
    permissions:
      contents: write
      id-token: write  # Required for npm provenance
    env:
      TAG_NAME: ${{ needs.release-please.outputs.tag_name || inputs.tag_name || github.ref_name }}

    steps:
      - uses: actions/checkout@v4

      - name: Download all artifacts
        uses: actions/download-artifact@v4
        with:
          path: artifacts

      - name: Restore platform packages
        run: |
          for platform in darwin-arm64 darwin-x64 linux-x64 linux-arm64 win32-x64 win32-arm64; do
            cp -r artifacts/$platform/* packages/$platform/
            chmod +x packages/$platform/bin/* 2>/dev/null || true
          done
          ls -la packages/*/bin/

      - name: Prepare release assets
        run: |
          mkdir -p release
          # Create tarballs for each Unix platform
          for platform in darwin-arm64 darwin-x64 linux-x64 linux-arm64; do
            tar -czvf release/agent-rdp-$platform.tar.gz -C packages/$platform/bin agent-rdp
          done
          # Create zips for Windows
          for platform in win32-x64 win32-arm64; do
            (cd packages/$platform/bin && zip ../../../release/agent-rdp-$platform.zip agent-rdp.exe)
          done
          ls -la release/

      - name: Create GitHub Release if needed
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          if ! gh release view "$TAG_NAME" &>/dev/null; then
            gh release create "$TAG_NAME" --title "agent-rdp: ${TAG_NAME#agent-rdp-}" --generate-notes
          fi

      - name: Upload binaries to GitHub Release
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          gh release upload "$TAG_NAME" release/* --clobber

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          registry-url: 'https://registry.npmjs.org'

      - name: Update npm for OIDC support
        run: npm install -g npm@latest

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 9

      - name: Install dependencies
        run: pnpm install --ignore-scripts

      - name: Build TypeScript
        run: pnpm --filter agent-rdp run build:ts

      - name: Publish platform packages
        run: |
          for platform in darwin-arm64 darwin-x64 linux-x64 linux-arm64 win32-x64 win32-arm64; do
            echo "Publishing @agent-rdp/$platform..."
            pnpm --filter "@agent-rdp/$platform" publish --access public --provenance --no-git-checks
          done

      - name: Publish main package
        run: |
          cp README.md packages/agent-rdp/
          pnpm --filter agent-rdp publish --access public --provenance --no-git-checks
